{% macro ft_launcher_setup(fault_tol_cfg_path, fault_tol_finished_flag_file, fault_tol_job_results_file) -%}

export FAULT_TOL_CFG_PATH="{{fault_tol_cfg_path}}"
export FAULT_TOL_FINISHED_FLAG_FILE="{{fault_tol_finished_flag_file}}"
export FAULT_TOL_JOB_RESULTS_FILE="{{fault_tol_job_results_file}}"

is_training_finished() {
    test -f "$FAULT_TOL_FINISHED_FLAG_FILE"
}

if is_training_finished ; then
    echo "[FT-Setup] Found finished flag at $FAULT_TOL_FINISHED_FLAG_FILE."
    echo "[FT-Setup] Training is already complete. Exiting successfully."
    exit 0
fi

echo "[FT-Setup] Starting training on $(hostname)..."
if [ -n "$FAULT_TOL_JOB_RESULTS_FILE" ]; then
    mkdir -p "$(dirname "$FAULT_TOL_JOB_RESULTS_FILE")"
    echo "$(hostname) $(date +%s) X" >> "$FAULT_TOL_JOB_RESULTS_FILE"
fi

{%- endmacro %}

{% macro ft_launcher_teardown() -%}
if [ "$exitcode" -eq "0" ]; then
    RESULT_STATUS="S" # Success
else
    RESULT_STATUS="F" # Failure
fi

if [ -n "$FAULT_TOL_JOB_RESULTS_FILE" ]; then
    mkdir -p "$(dirname "$FAULT_TOL_JOB_RESULTS_FILE")"
    echo "$(hostname) $(date +%s) $RESULT_STATUS" >> "$FAULT_TOL_JOB_RESULTS_FILE"
fi

if [ "$exitcode" -eq "0" ]; then
    if is_training_finished; then
        echo "[FT-Teardown] Job finished successfully and flag file exists."
        exit 0
    else
        echo "[FT-Teardown] WARNING: Process exited 0 but finished flag is MISSING."
        echo "[FT-Teardown] Forcing exit 1 to trigger Kubernetes restart."
        exit 1
    fi
else
    echo "[FT-Teardown] Job failed with exit code $exitcode."
    exit $exitcode
fi
{%- endmacro %}
