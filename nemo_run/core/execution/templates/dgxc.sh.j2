{%- import "ft_launcher_k8s.j2" as fault_tolerance -%}
#!/bin/bash
#
# Generated by NeMo Run for Kubernetes (PyTorchJob)
#

# 1. Basic Shell Setup
set -evx  # Print commands, but DO NOT exit immediately on error (we handle that below)
export PYTHONUNBUFFERED=1
export TORCHX_MAX_RETRIES={{max_retries}}

# 2. Environment Variables
# These are strictly user-defined vars (e.g. HYDRA_FULL_ERROR).
# Note: MASTER_ADDR, WORLD_SIZE, RANK are injected automatically by the PyTorchJob operator.
{%- for env_var in env_vars %}
{{env_var}}
{%- endfor %}

# 3. Fault Tolerance: SETUP (Check-in)
# Checks if we are resuming or if we are already finished.
{%- if ft_enabled %}
{{ fault_tolerance.ft_launcher_setup(fault_tol_cfg_path, fault_tol_finished_flag_file, fault_tol_job_results_file) }}
{%- endif %}

# 4. Main Execution
# In PyTorchJob, we usually have exactly one main command (torchrun).
# We assume the variable 'training_command' contains the full torchrun string.

echo "Starting training command..."
set +e # Turn off auto-exit so we can capture the code
# ---------------------------------------------------------
{{ training_command }}
# ---------------------------------------------------------
exitcode=$?
set -e

echo "Main command exited with code $exitcode"

# 5. Fault Tolerance: TEARDOWN (Check-out)
# Decides if we should exit 0 (complete) or exit 1 (retry via K8s backoffLimit).
{%- if ft_enabled %}
{{ fault_tolerance.ft_launcher_teardown() }}
{%- else %}
# If FT is disabled, simply pass the exit code through.
# K8s will restart if exitcode != 0 and backoffLimit > 0.
exit $exitcode
{%- endif %}
